<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="mapper.MissingMapper">
	
    <resultMap type="dto.MissingPersonDTO" id="missing">
		<result column="missing_serialNum" property="missingSerialNum" />
		<result column="member_serialNum" property="memberSerialNum" />
		<result column="admin_serialNum" property="adminSerialNum" />
		<result column="missing_name" property="name" />
		<result column="missing_gender" property="gender" />
		<result column="missing_birth" property="birth" />
		<result column="missing_etc" property="etc" />
		<result column="missing_place" property="place" />
		<result column="missing_date" property="missingDate" />
		<result column="missing_img" property="image" />
	</resultMap>

	<insert id="insertMissingPerson"
		parameterType="dto.MissingPersonDTO">
		INSERT INTO missing_info (
		member_serialNum,
		missing_name,
		missing_gender,
		missing_birth,
		missing_etc,
		missing_place,
		missing_date,
		missing_img
		) VALUES (
		#{memberSerialNum},
		#{name},
		#{gender},
		TO_NUMBER(REPLACE(#{birth}, '-', '')),
		#{etc},
		#{place},
		TO_DATE(#{missingDate}, 'YYYY-MM-DD'),
		#{image}
		)
	</insert>

	<select id="selectMissingList" resultMap="missing">
		SELECT * FROM (
			SELECT ROWNUM AS rnum, m.* FROM (
				SELECT 
					missing_serialNum,
					member_serialNum,
					admin_serialNum,
					missing_name,
					missing_gender,
					TO_CHAR(TO_DATE(missing_birth, 'YYYYMMDD'), 'YYYY-MM-DD') as missing_birth,
					missing_etc,
					missing_place,
					TO_CHAR(missing_date, 'YYYY-MM-DD') as missing_date,
					missing_img
				FROM missing_info ORDER BY missing_serialNum DESC
			) m
		) WHERE rnum BETWEEN #{startRow} AND #{endRow}
	</select>

	<select id="selectMissingCount" resultType="int">
		SELECT COUNT(*) FROM missing_info
	</select>

	<select id="selectAdminSerialNumByMember" parameterType="string"
		resultType="string">
		SELECT admin_serialNum FROM member_info WHERE member_serialNum =
		#{memberSerialNum}
	</select>

	<delete id="deleteMissingPerson" parameterType="string">
		DELETE FROM missing_info WHERE missing_serialNum = #{missingSerialNum}
	</delete>
	
	<select id="selectMissingById" parameterType="string" resultMap="missing">
        SELECT * FROM missing_info WHERE missing_serialNum = #{serialNum}
    </select>
    
    <select id="selectMissingListMain" resultMap="missing">
		SELECT * FROM missing_info
		ORDER BY missing_serialNum DESC
	</select>
	
	<select id="selectMissingPersonBySerialNum" parameterType="string" resultMap="missing">
    	SELECT 
	        missing_serialNum,
	        member_serialNum,
	        admin_serialNum,
	        missing_name,
	        missing_gender,
	        TO_CHAR(TO_DATE(missing_birth, 'YYYYMMDD'), 'YYYY-MM-DD') as missing_birth,
	        missing_etc,
	        missing_place,
	        TO_CHAR(missing_date, 'YYYY-MM-DD') as missing_date,
	        missing_img
	    FROM missing_info 
	    WHERE missing_serialNum = #{serialNum}
	</select>
	
	<update id="updateMissingPerson" parameterType="dto.MissingPersonDTO">
    UPDATE missing_info
       SET missing_name = #{name},
           missing_gender = #{gender},
           missing_birth = TO_NUMBER(REPLACE(#{birth}, '-', '')),
           missing_etc = #{etc},
           missing_place = #{place},
           missing_date = TO_DATE(#{missingDate}, 'YYYY-MM-DD')
           <if test="image != null">
           , missing_img = #{image}
           </if>
     WHERE missing_serialNum = #{missingSerialNum}
	</update>
</mapper>